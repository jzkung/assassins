<% require 'digest/sha1' %>

<% pass = "test" %>



<% if session[:current_user_id].nil? %>
  	<% content_for :title, "Welcome to Assassins" %>
  	<%= link_to "Sign In", controller: :users, action: :login %> or <%= link_to "Sign Up", controller: :users, action: :new %>!
<% else %>
<% @current_user = User.find(session[:current_user_id]) %>
<% if @current_user.is_admin? %>
  	<% content_for :title, "Game Manager" %><br><br>
	<% @games.each do |game| %>
		<h2><p><b> <%= game.name %> </b></p></h2>
		<% if game.is_started? %>
			<div class="container">
				<div class="row">
					<div class="span5">
						<h3><p>Alive</p></h3>
						<% @users.each do |user| %>
							<% if !user.is_admin? && user.game_id == game.id%>
								<% if user.status == "alive" %>
									<h4><p><%= user.first_name %> <%= user.last_name %> </p></h4>
								<% end %>
							<% end %>
						<% end %>
					</div>
					<div class="span5">
						<h3><p>Dead</p></h3>
						<% @users.each do |user| %>
							<% if !user.is_admin? && user.game_id == game.id%>
								<% if user.status == "dead" %>
									<h4><p><%= user.first_name %> <%= user.last_name %> </p></h4>
								<% end %>
							<% end %>
						<% end %>
					</div>
					<div class="span5">
						<h3><p>Kills</p></h3>
						<% @kills.each do |kill| %>
							<h4><p>Assassin: <%= kill.assassin.first_name %> <%= kill.assassin.last_name %></p>
								<p>Target: <%= kill.target.first_name %> <%= kill.target.last_name %></p>
								<p>Time Stamp: <%= kill.time_killed.to_formatted_s(:long_ordinal) %></p>
								<br><br></h4>
						<% end %>
					</div>
					<div class="span5">
						<h3><p>To Be Terminated</p></h3>
						<% @users.each do |user| %>
							<% if !user.is_admin? && user.game_id == game.id && user.status == "alive"%>
								<% if DateTime.now > user.term_date %>
									<h4><p><%= user.first_name %> <%= user.last_name %> </p></h4>
									<% url = "kills/terminate?id=" + user.id.to_s %>
									<%= form_tag(url) do |f| %>
  										<%= submit_tag "Terminate!" %> <br>
									<% end %>
								<% end %>
							<% end %>
						<% end %>
					</div>
				</div>
			</div>
		<% else %>
			<% url = "games/start?id=" + game.id.to_s %>
			<%= form_tag(url) do |f| %>
  				<%= submit_tag "Start Game!" %>
			<% end %>
		<% end %>
	<% end %>
<% elsif @current_user.game_id.blank? %>
	<h4><p> You haven't signed up for a game yet.</p>
		<p> Click <%= link_to "Join Game", controller: :games, action: :new %> to join a game </p></h4>

<% elsif !@current_user.game.is_started %>
	<h4><p> Your game, <%= @current_user.game.name %>, has not started yet. </p>
		<p> Prepare yourself for the battle. </p>
		<p> You will receive an email when the game begins and can check here periodically for its status. </p>
		<p> And don't forget your kill code: <b><%= @current_user.kill_code %>. </p> </h4>

<% elsif @current_user.status == "dead" %>
	<h4><p> Thank you for playing assassins. </p>
		<p> We wish you better luck in the next round. </p></h4>

<% elsif @current_user.target == @current_user %>
	<h3><p>YOU WON!!</p>
		<p>CONGRATULATIONS!!</p></h3>
		
<% else %>
	<h4><p> It is currently <%= DateTime.now.to_formatted_s(:long_ordinal) %>. </p>
		<% if DateTime.now > @current_user.term_date %>
			<p> You are currently a target for the terminators! </p>
			<p> Kill your target as soon as possible before they kill you! </p>
			<p> Your target is: <b><%= @current_user.target.first_name %> <%= @current_user.target.last_name %></b>. </p>
			<p> Your kill code is: <b><%= @current_user.kill_code %></b>. </p>
		<% else %>
			<p> Your target is: <b><%= @current_user.target.first_name %> <%= @current_user.target.last_name %></b>. </p>
			<p> Your kill code is: <b><%= @current_user.kill_code %></b>. </p>
			<p> You have until <%= @current_user.term_date.to_formatted_s(:long_ordinal) %> before the terminators come after you. </p>
			<p> Kill your target to extend the deadline! </p></h4>
		<% end %>
<% end %>
<% end %>